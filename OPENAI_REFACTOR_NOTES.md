# OpenAI Assistants API Refactoring Notes

## 1. Database Schema Updates
You must apply the following SQL to your Supabase project to support the new features:

```sql
-- Run this in Supabase SQL Editor
ALTER TABLE public.projects ADD COLUMN IF NOT EXISTS openai_thread_id TEXT;
ALTER TABLE public.documents ADD COLUMN IF NOT EXISTS openai_file_id TEXT;
CREATE INDEX IF NOT EXISTS idx_projects_thread_id ON public.projects(openai_thread_id);
```

## 2. Environment Variables
The refactoring requires the following new environment variable in `.env`:
```
NEXT_PUBLIC_OPENAI_ASSISTANT_ID=asst_WIpxa5DuIKPTkBtKk0QC61gZ
```
(This ID was generated by the `setup_assistant.js` script I ran).

## 3. How It Works
- **Workspace == Thread**: Each Project now has a unique OpenAI Thread ID.
- **File Uploads**: When you upload a file, it is sent to OpenAI Files API and attached to the Project's Thread.
- **Chat**: Messages are sent to the Project's Thread. The "Betsy Data Analyst" Assistant (ID above) runs on this thread.
- **Tools**:
    - **Code Interpreter**: Enabled for data analysis (CSV/Excel) and Python execution.
    - **File Search**: Enabled for retrieving text from PDFs/Docs.
- **Persistence**: Thread ID is stored in Supabase, so context is preserved when you return to a project.

## 4. Helper Scripts
- `setup_assistant.js`: Creates the OpenAI Assistant with the required instructions.
- `update_schema_openai_assistants.sql`: The SQL required for the DB.
